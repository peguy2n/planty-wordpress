import{c as createStore}from"./index-1046c77e.js";import{g as getSerializedState}from"./utils-00526fde.js";import{g as getQueryArg}from"./get-query-arg-cb6b8763.js";import{m as maybeConvertAmount}from"./currency-728311ef.js";import{g as getQueryArgs,b as buildQueryString,a as addQueryArgs}from"./add-query-args-f4c5962b.js";const safeRead=(t,e)=>{try{return JSON.parse(t.getItem(e))}catch{return null}},debounce=t=>{let e=!1;return()=>{e||(e=!0,setTimeout((()=>{t(),e=!1}),0))}},createStorageStore=(t,e,o,n=!1)=>{var i;const d=createStore(null!==(i=safeRead(t,e))&&void 0!==i?i:o,((t,e)=>JSON.stringify(t)!==JSON.stringify(e))),u=debounce((()=>t.setItem(e,JSON.stringify(d.state))));return u(),n&&window.addEventListener("storage",(()=>{const o=safeRead(t,e);if(null!==o)for(const t in o)d.set(t,o[t])})),d.use({set:u,reset:u}),d},createLocalStore=(t,e,o=!1)=>createStorageStore(localStorage,t,e,o);function removeQueryArgs(t){const e=t.indexOf("?");if(-1===e)return t;const o=getQueryArgs(t),n=t.substr(0,e);for(var i=arguments.length,d=new Array(i>1?i-1:0),u=1;u<i;u++)d[u-1]=arguments[u];d.forEach((t=>delete o[t]));const r=buildQueryString(o);return r?n+"?"+r:n}const{checkout:checkout$1}=getSerializedState(),notPersistCart="browser"!==(null==checkout$1?void 0:checkout$1.persist)||!!getQueryArg(window.location.href,"no_cart"),store=notPersistCart?createStore({live:{},test:{}}):createLocalStore("surecart-local-storage",{live:{},test:{}},!0),{state:state$1,onChange:onChange$1,on:on$1,set:set$1,get:get$1,dispose:dispose$1}=store;window.scStore=store;const{checkout:checkout}=getSerializedState(),{state:state,onChange:onChange,on:on,set:set,get:get,dispose:dispose}=createStore({formId:null,groupId:null,mode:"live",locks:[],product:null,checkout:null,currencyCode:"usd",abandonedCheckoutEnabled:!0,initialLineItems:[],isCheckoutPage:!1,validateStock:!1,persist:"browser",...checkout},((t,e)=>JSON.stringify(t)!==JSON.stringify(e)));onChange("checkout",(t=>setCheckout(t,state.formId))),on("get",(t=>{if("checkout"===t){const t=getCheckout(state.formId,state.mode);(null==t?void 0:t.id)&&(state.checkout=t)}})),on$1("set",((t,e,o)=>Object.keys(e||{}).forEach((t=>handleCheckoutLineItemChange(e[t],null==o?void 0:o[t])))));const handleCheckoutLineItemChange=(t,e)=>{var o,n;const i=(null===(o=null==t?void 0:t.line_items)||void 0===o?void 0:o.data)||[],d=(null===(n=null==e?void 0:e.line_items)||void 0===n?void 0:n.data)||[];if(i.forEach((t=>{const e=d.find((e=>e.id===t.id));if(!e||(null==e?void 0:e.quantity)<(null==t?void 0:t.quantity)){const o=new CustomEvent("scAddedToCart",{detail:{...t,quantity:t.quantity-((null==e?void 0:e.quantity)||0)},bubbles:!0});document.dispatchEvent(o)}})),d.forEach((t=>{const e=i.find((e=>e.id===t.id));if(!e||(null==t?void 0:t.quantity)>(null==e?void 0:e.quantity)){const o=new CustomEvent("scRemovedFromCart",{detail:{...t,quantity:t.quantity-((null==e?void 0:e.quantity)||0)},bubbles:!0});document.dispatchEvent(o)}})),JSON.stringify(i)!==JSON.stringify(d)){const o=new CustomEvent("scCartUpdated",{detail:[t,e],bubbles:!0});document.dispatchEvent(o)}};on("set",((t,e,o)=>{var n,i,d,u,r;if("checkout"!==t)return;if(null==o?void 0:o.id)return;if(!(null==e?void 0:e.id))return;if(!state.isCheckoutPage)return;const l=new CustomEvent("scCheckoutInitiated",{detail:{transaction_id:e.id,value:maybeConvertAmount(null==e?void 0:e.total_amount,(null==e?void 0:e.currency)||"USD"),currency:(e.currency||"").toUpperCase(),...(null===(i=null===(n=null==e?void 0:e.discount)||void 0===n?void 0:n.promotion)||void 0===i?void 0:i.code)?{coupon:null===(u=null===(d=null==e?void 0:e.discount)||void 0===d?void 0:d.promotion)||void 0===u?void 0:u.code}:{},...(null==e?void 0:e.tax_amount)?{tax:maybeConvertAmount(null==e?void 0:e.tax_amount,(null==e?void 0:e.currency)||"USD")}:{},items:((null===(r=null==e?void 0:e.line_items)||void 0===r?void 0:r.data)||[]).map((t=>{var o,n,i;return{item_name:(null===(n=null===(o=null==t?void 0:t.price)||void 0===o?void 0:o.product)||void 0===n?void 0:n.name)||"",discount:(null==t?void 0:t.discount_amount)?maybeConvertAmount((null==t?void 0:t.discount_amount)||0,(null==e?void 0:e.currency)||"USD"):0,price:maybeConvertAmount((null===(i=null==t?void 0:t.price)||void 0===i?void 0:i.amount)||0,(null==e?void 0:e.currency)||"USD"),quantity:(null==t?void 0:t.quantity)||1}}))},bubbles:!0});document.dispatchEvent(l)})),on("set",((t,e,o)=>{var n;if("checkout"!==t)return;if(!(null==e?void 0:e.status)||(null==o?void 0:o.status)===(null==e?void 0:e.status))return;if(!["paid","processing"].includes(e.status))return;const i=new CustomEvent("scOrderPaid",{detail:e,bubbles:!0});document.dispatchEvent(i);const d=new CustomEvent("scCheckoutCompleted",{detail:e,bubbles:!0});document.dispatchEvent(d);const u=((null===(n=null==e?void 0:e.line_items)||void 0===n?void 0:n.data)||[]).filter((t=>{var e;return(null===(e=null==t?void 0:t.price)||void 0===e?void 0:e.trial_duration_days)>0}));if(u.length>0){const t=new CustomEvent("scTrialStarted",{detail:u,bubbles:!0});document.dispatchEvent(t)}})),window.addEventListener("scAddedToCart",(function(t){var e,o,n,i,d,u,r,l,a;if(!(null===window||void 0===window?void 0:window.dataLayer)&&!(null===window||void 0===window?void 0:window.gtag))return;const c=t.detail;if(!(null===(e=null==c?void 0:c.price)||void 0===e?void 0:e.product))return;const s=[{item_id:null===(n=null===(o=c.price)||void 0===o?void 0:o.product)||void 0===n?void 0:n.id,item_name:null===(d=null===(i=c.price)||void 0===i?void 0:i.product)||void 0===d?void 0:d.name,item_variant:(c.variant_options||[]).join(" / "),price:maybeConvertAmount((null===(u=null==c?void 0:c.price)||void 0===u?void 0:u.amount)||0,(null===(r=c.price)||void 0===r?void 0:r.currency)||"USD"),currency:null===(l=c.price)||void 0===l?void 0:l.currency,quantity:c.quantity,discount:(null==c?void 0:c.discount_amount)?maybeConvertAmount((null==c?void 0:c.discount_amount)||0,(null===(a=c.price)||void 0===a?void 0:a.currency)||"USD"):0}];(null===window||void 0===window?void 0:window.gtag)&&window.gtag("event","add_to_cart",{items:s}),(null===window||void 0===window?void 0:window.dataLayer)&&(window.dataLayer.push({ecommerce:null}),window.dataLayer.push({event:"add_to_cart",ecommerce:{data:{items:s}}}))})),window.addEventListener("scCheckoutCompleted",(function(t){var e,o,n,i,d;if(!(null===window||void 0===window?void 0:window.dataLayer)&&!(null===window||void 0===window?void 0:window.gtag))return;const u=t.detail,r={transaction_id:null==u?void 0:u.id,value:maybeConvertAmount(null==u?void 0:u.total_amount,(null==u?void 0:u.currency)||"USD"),currency:(u.currency||"").toUpperCase(),...(null===(o=null===(e=null==u?void 0:u.discount)||void 0===e?void 0:e.promotion)||void 0===o?void 0:o.code)?{coupon:null===(i=null===(n=null==u?void 0:u.discount)||void 0===n?void 0:n.promotion)||void 0===i?void 0:i.code}:{},...(null==u?void 0:u.tax_amount)?{tax:maybeConvertAmount(null==u?void 0:u.tax_amount,(null==u?void 0:u.currency)||"USD")}:{},items:((null===(d=null==u?void 0:u.line_items)||void 0===d?void 0:d.data)||[]).map((t=>{var e,o,n,i,d,r,l;return{item_id:null===(o=null===(e=null==t?void 0:t.price)||void 0===e?void 0:e.product)||void 0===o?void 0:o.id,currency:(u.currency||"").toUpperCase(),item_name:(null===(i=null===(n=null==t?void 0:t.price)||void 0===n?void 0:n.product)||void 0===i?void 0:i.name)||"",discount:(null==t?void 0:t.discount_amount)?maybeConvertAmount((null==t?void 0:t.discount_amount)||0,(null===(d=null==t?void 0:t.price)||void 0===d?void 0:d.currency)||"USD"):0,price:maybeConvertAmount((null===(r=null==t?void 0:t.price)||void 0===r?void 0:r.amount)||0,(null===(l=null==t?void 0:t.price)||void 0===l?void 0:l.currency)||"USD"),quantity:(null==t?void 0:t.quantity)||1,item_variant:(t.variant_options||[]).join(" / ")}}))};(null===window||void 0===window?void 0:window.gtag)&&window.gtag("event","purchase",r),(null===window||void 0===window?void 0:window.dataLayer)&&(window.dataLayer.push({ecommerce:null}),window.dataLayer.push({event:"purchase",ecommerce:r}))}));const getCheckout=(t,e)=>{var o;return(null===(o=store.state[e])||void 0===o?void 0:o[t])||{}},setCheckout=(t,e)=>{const o=(null==t?void 0:t.live_mode)?"live":"test";store.set(o,{...store.state[o],[e]:t}),state.formId===e&&state.mode===o&&(state.checkout=t),"url"===state.persist&&(null==t?void 0:t.id)&&window.history.replaceState({},document.title,addQueryArgs(window.location.href,{checkout_id:null==t?void 0:t.id}))},clearCheckout=(t,e)=>{const{[t]:o,...n}=store.state[e];return window.history.replaceState({},document.title,removeQueryArgs(window.location.href,"redirect_status","coupon","line_items","confirm_checkout_id","checkout_id")),store.set(e,n)};export{setCheckout as a,onChange$1 as b,clearCheckout as c,on as d,getCheckout as g,onChange as o,removeQueryArgs as r,state as s};