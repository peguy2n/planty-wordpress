import{c as createStore}from"./index3.js";import{g as getSerializedState}from"./utils.js";import{g as getQueryArg}from"./get-query-arg.js";import{m as maybeConvertAmount}from"./currency.js";import{g as getQueryArgs,b as buildQueryString,a as addQueryArgs}from"./add-query-args.js";const safeRead=(t,o)=>{try{return JSON.parse(t.getItem(o))}catch{return null}},debounce=t=>{let o=!1;return()=>{o||(o=!0,setTimeout((()=>{t(),o=!1}),0))}},createStorageStore=(t,o,e,n=!1)=>{var i;const d=createStore(null!==(i=safeRead(t,o))&&void 0!==i?i:e,((t,o)=>JSON.stringify(t)!==JSON.stringify(o))),u=debounce((()=>t.setItem(o,JSON.stringify(d.state))));return u(),n&&window.addEventListener("storage",(()=>{const e=safeRead(t,o);if(null!==e)for(const t in e)d.set(t,e[t])})),d.use({set:u,reset:u}),d},createLocalStore=(t,o,e=!1)=>createStorageStore(localStorage,t,o,e);function removeQueryArgs(t){const o=t.indexOf("?");if(-1===o)return t;const e=getQueryArgs(t),n=t.substr(0,o);for(var i=arguments.length,d=new Array(i>1?i-1:0),u=1;u<i;u++)d[u-1]=arguments[u];d.forEach((t=>delete e[t]));const r=buildQueryString(e);return r?n+"?"+r:n}const{checkout:checkout$1}=getSerializedState(),notPersistCart="browser"!==(null==checkout$1?void 0:checkout$1.persist)||!!getQueryArg(window.location.href,"no_cart"),store=notPersistCart?createStore({live:{},test:{}}):createLocalStore("surecart-local-storage",{live:{},test:{}},!0),{state:state$1,onChange:onChange$1,on:on$1,set:set$1,get:get$1,dispose:dispose$1}=store;window.scStore=store;const{checkout:checkout}=getSerializedState(),{state:state,onChange:onChange,on:on,set:set,get:get,dispose:dispose}=createStore({formId:null,groupId:null,mode:"live",locks:[],product:null,checkout:null,currencyCode:"usd",abandonedCheckoutEnabled:!0,initialLineItems:[],isCheckoutPage:!1,validateStock:!1,persist:"browser",...checkout},((t,o)=>JSON.stringify(t)!==JSON.stringify(o)));onChange("checkout",(t=>setCheckout(t,state.formId))),on("get",(t=>{if("checkout"===t){const t=getCheckout(state.formId,state.mode);(null==t?void 0:t.id)&&(state.checkout=t)}})),on$1("set",((t,o,e)=>Object.keys(o||{}).forEach((t=>handleCheckoutLineItemChange(o[t],null==e?void 0:e[t])))));const handleCheckoutLineItemChange=(t,o)=>{var e,n;const i=(null===(e=null==t?void 0:t.line_items)||void 0===e?void 0:e.data)||[],d=(null===(n=null==o?void 0:o.line_items)||void 0===n?void 0:n.data)||[];if(i.forEach((t=>{const o=d.find((o=>o.id===t.id));if(!o||(null==o?void 0:o.quantity)<(null==t?void 0:t.quantity)){const e=new CustomEvent("scAddedToCart",{detail:{...t,quantity:t.quantity-((null==o?void 0:o.quantity)||0)},bubbles:!0});document.dispatchEvent(e)}})),d.forEach((t=>{const o=i.find((o=>o.id===t.id));if(!o||(null==t?void 0:t.quantity)>(null==o?void 0:o.quantity)){const e=new CustomEvent("scRemovedFromCart",{detail:{...t,quantity:t.quantity-((null==o?void 0:o.quantity)||0)},bubbles:!0});document.dispatchEvent(e)}})),JSON.stringify(i)!==JSON.stringify(d)){const e=new CustomEvent("scCartUpdated",{detail:[t,o],bubbles:!0});document.dispatchEvent(e)}};on("set",((t,o,e)=>{var n,i,d,u,r;if("checkout"!==t)return;if(null==e?void 0:e.id)return;if(!(null==o?void 0:o.id))return;if(!state.isCheckoutPage)return;const l=new CustomEvent("scCheckoutInitiated",{detail:{transaction_id:o.id,value:maybeConvertAmount(null==o?void 0:o.total_amount,(null==o?void 0:o.currency)||"USD"),currency:(o.currency||"").toUpperCase(),...(null===(i=null===(n=null==o?void 0:o.discount)||void 0===n?void 0:n.promotion)||void 0===i?void 0:i.code)?{coupon:null===(u=null===(d=null==o?void 0:o.discount)||void 0===d?void 0:d.promotion)||void 0===u?void 0:u.code}:{},...(null==o?void 0:o.tax_amount)?{tax:maybeConvertAmount(null==o?void 0:o.tax_amount,(null==o?void 0:o.currency)||"USD")}:{},items:((null===(r=null==o?void 0:o.line_items)||void 0===r?void 0:r.data)||[]).map((t=>{var e,n,i;return{item_name:(null===(n=null===(e=null==t?void 0:t.price)||void 0===e?void 0:e.product)||void 0===n?void 0:n.name)||"",discount:(null==t?void 0:t.discount_amount)?maybeConvertAmount((null==t?void 0:t.discount_amount)||0,(null==o?void 0:o.currency)||"USD"):0,price:maybeConvertAmount((null===(i=null==t?void 0:t.price)||void 0===i?void 0:i.amount)||0,(null==o?void 0:o.currency)||"USD"),quantity:(null==t?void 0:t.quantity)||1}}))},bubbles:!0});document.dispatchEvent(l)})),on("set",((t,o,e)=>{var n;if("checkout"!==t)return;if(!(null==o?void 0:o.status)||(null==e?void 0:e.status)===(null==o?void 0:o.status))return;if(!["paid","processing"].includes(o.status))return;const i=new CustomEvent("scOrderPaid",{detail:o,bubbles:!0});document.dispatchEvent(i);const d=new CustomEvent("scCheckoutCompleted",{detail:o,bubbles:!0});document.dispatchEvent(d);const u=((null===(n=null==o?void 0:o.line_items)||void 0===n?void 0:n.data)||[]).filter((t=>{var o;return(null===(o=null==t?void 0:t.price)||void 0===o?void 0:o.trial_duration_days)>0}));if(u.length>0){const t=new CustomEvent("scTrialStarted",{detail:u,bubbles:!0});document.dispatchEvent(t)}})),window.addEventListener("scAddedToCart",(function(t){var o,e,n,i,d,u,r,l,a;if(!(null===window||void 0===window?void 0:window.dataLayer)&&!(null===window||void 0===window?void 0:window.gtag))return;const c=t.detail;if(!(null===(o=null==c?void 0:c.price)||void 0===o?void 0:o.product))return;const s=[{item_id:null===(n=null===(e=c.price)||void 0===e?void 0:e.product)||void 0===n?void 0:n.id,item_name:null===(d=null===(i=c.price)||void 0===i?void 0:i.product)||void 0===d?void 0:d.name,item_variant:(c.variant_options||[]).join(" / "),price:maybeConvertAmount((null===(u=null==c?void 0:c.price)||void 0===u?void 0:u.amount)||0,(null===(r=c.price)||void 0===r?void 0:r.currency)||"USD"),currency:null===(l=c.price)||void 0===l?void 0:l.currency,quantity:c.quantity,discount:(null==c?void 0:c.discount_amount)?maybeConvertAmount((null==c?void 0:c.discount_amount)||0,(null===(a=c.price)||void 0===a?void 0:a.currency)||"USD"):0}];(null===window||void 0===window?void 0:window.gtag)&&window.gtag("event","add_to_cart",{items:s}),(null===window||void 0===window?void 0:window.dataLayer)&&(window.dataLayer.push({ecommerce:null}),window.dataLayer.push({event:"add_to_cart",ecommerce:{data:{items:s}}}))})),window.addEventListener("scCheckoutCompleted",(function(t){var o,e,n,i,d;if(!(null===window||void 0===window?void 0:window.dataLayer)&&!(null===window||void 0===window?void 0:window.gtag))return;const u=t.detail,r={transaction_id:null==u?void 0:u.id,value:maybeConvertAmount(null==u?void 0:u.total_amount,(null==u?void 0:u.currency)||"USD"),currency:(u.currency||"").toUpperCase(),...(null===(e=null===(o=null==u?void 0:u.discount)||void 0===o?void 0:o.promotion)||void 0===e?void 0:e.code)?{coupon:null===(i=null===(n=null==u?void 0:u.discount)||void 0===n?void 0:n.promotion)||void 0===i?void 0:i.code}:{},...(null==u?void 0:u.tax_amount)?{tax:maybeConvertAmount(null==u?void 0:u.tax_amount,(null==u?void 0:u.currency)||"USD")}:{},items:((null===(d=null==u?void 0:u.line_items)||void 0===d?void 0:d.data)||[]).map((t=>{var o,e,n,i,d,r,l;return{item_id:null===(e=null===(o=null==t?void 0:t.price)||void 0===o?void 0:o.product)||void 0===e?void 0:e.id,currency:(u.currency||"").toUpperCase(),item_name:(null===(i=null===(n=null==t?void 0:t.price)||void 0===n?void 0:n.product)||void 0===i?void 0:i.name)||"",discount:(null==t?void 0:t.discount_amount)?maybeConvertAmount((null==t?void 0:t.discount_amount)||0,(null===(d=null==t?void 0:t.price)||void 0===d?void 0:d.currency)||"USD"):0,price:maybeConvertAmount((null===(r=null==t?void 0:t.price)||void 0===r?void 0:r.amount)||0,(null===(l=null==t?void 0:t.price)||void 0===l?void 0:l.currency)||"USD"),quantity:(null==t?void 0:t.quantity)||1,item_variant:(t.variant_options||[]).join(" / ")}}))};(null===window||void 0===window?void 0:window.gtag)&&window.gtag("event","purchase",r),(null===window||void 0===window?void 0:window.dataLayer)&&(window.dataLayer.push({ecommerce:null}),window.dataLayer.push({event:"purchase",ecommerce:r}))}));const getCheckout=(t,o)=>{var e;return(null===(e=store.state[o])||void 0===e?void 0:e[t])||{}},setCheckout=(t,o)=>{const e=(null==t?void 0:t.live_mode)?"live":"test";store.set(e,{...store.state[e],[o]:t}),state.formId===o&&state.mode===e&&(state.checkout=t),"url"===state.persist&&(null==t?void 0:t.id)&&window.history.replaceState({},document.title,addQueryArgs(window.location.href,{checkout_id:null==t?void 0:t.id}))},clearCheckout=(t,o)=>{const{[t]:e,...n}=store.state[o];return window.history.replaceState({},document.title,removeQueryArgs(window.location.href,"redirect_status","coupon","line_items","confirm_checkout_id","checkout_id")),store.set(o,n)};export{setCheckout as a,onChange$1 as b,clearCheckout as c,on as d,getCheckout as g,onChange as o,removeQueryArgs as r,state as s};